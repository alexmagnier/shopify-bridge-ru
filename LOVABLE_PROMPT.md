# Промпт для Lovable.dev

Скопируй этот текст и отправь в чат Lovable после импорта проекта:

---

## Задача

Подключи этот партнёрский кабинет к Supabase. Замени все mock-данные на реальные запросы к базе данных.

## База данных

Создай таблицы из файла `DATABASE_SCHEMA.sql`:

1. **partners** - партнёры с балансом и уровнями
2. **referrals** - рефералы с lifetime-трекингом
3. **commission_records** - записи о КАЖДОЙ комиссии (важно!)
4. **payouts** - запросы на выплаты
5. **referral_clicks** - клики для аналитики
6. **admins** - администраторы
7. **settings** - настройки программы

## Ключевая бизнес-логика (ВАЖНО!)

### 1. Lifetime комиссии
Партнёр получает комиссию **с каждого платежа клиента**:
- Первый платёж (setup) → комиссия
- Каждый квартальный платёж (maintenance) → комиссия снова!

Клиент платит **$450 за обслуживание каждый квартал** → партнёр получает 10-20% **каждый раз**.

### 2. Бессрочная привязка клиентов
Реферальный код сохраняется в:
- `localStorage` (ключ: `sb_ref`)
- `cookie` (срок: 3650 дней = 10 лет)

Если клиент перешёл по ссылке партнёра → он закреплён **навсегда**.

### 3. Уровни партнёров
Автоматически повышай уровень по количеству активных рефералов:
- 0-4 → Standard (10%)
- 5-14 → Silver (12%)
- 15-29 → Gold (15%)
- 30-49 → Platinum (18%)
- 50+ → Master (20%)

### 4. Выплаты
Минимальная сумма: **$50**
Методы: `usdt_trc20`, `usdt_erc20`, `bank_card`

## Страницы для интеграции

### Партнёрский кабинет:
1. `/partners/register` - регистрация (создаёт партнёра, генерирует referral_code)
2. `/partners/login` - авторизация через Supabase Auth
3. `/partners/dashboard` - статистика партнёра (earnings, referrals, tier)
4. `/partners/referrals` - таблица рефералов с фильтрами
5. `/partners/payouts` - история выплат + запрос новой выплаты
6. `/partners/profile` - редактирование профиля + реквизиты
7. `/partners/materials` - промо-материалы (статичная страница, не трогай)

### Админ-панель:
1. `/admin` - вход админа (отдельная таблица admins)
2. `/admin/dashboard` - общая статистика
3. `/admin/partners` - список партнёров (создай CRUD)
4. `/admin/payouts` - обработка выплат (одобрение/отклонение)
5. `/admin/settings` - настройки комиссий

## Важные функции

### Генерация реферального кода
```typescript
// При регистрации генерируй уникальный код
// Формат: первые 3 буквы имени + 3 буквы фамилии + 4 цифры
// Пример: IVAIVA2847
```

### Трекинг рефералов
Компонент `ReferralTracker` уже создан в `src/components/ReferralTracker.tsx`.
Он сохраняет ref-код из URL параметра `?ref=XXX` в localStorage и cookie.

При регистрации клиента через форму на основном сайте:
1. Читай ref-код из `localStorage.getItem('sb_ref')`
2. Создавай запись в таблице `referrals` с `partner_id` из ref-кода
3. Статус: `registered`

### Начисление комиссий
Когда клиент **платит** (это происходит вне этого кабинета):
1. Создай запись в `commission_records` с:
   - `payment_type`: 'setup' (первый раз) или 'maintenance' (каждый квартал)
   - `commission_rate`: текущий % партнёра
   - `commission_amount`: payment_amount * rate
2. Обнови `referral.commission_earned` (+= commission_amount)
3. Обнови `partner.pending_balance` (+= commission_amount)

## Авторизация

Используй **Supabase Auth**:
- Email + Password для партнёров
- Отдельная таблица для админов с хешированными паролями
- JWT токены для защиты роутов

## Email-уведомления

Подключи **Resend** или **SendGrid**:
1. Приветственное письмо после регистрации
2. Уведомление о новом реферале
3. Уведомление о начислении комиссии
4. Уведомление о выплате

Шаблоны см. в спецификации (строки 2064-2176).

## Что НЕ трогать

- UI компоненты - они все готовы
- Дизайн и стили - всё ОК
- Структуру страниц - только подключи данные

## Что заменить

Найди все `TODO: Implement API call` и замени на реальные запросы:
- `MOCK_PARTNER` → запрос к `partners`
- `MOCK_REFERRALS` → запрос к `referrals`
- `MOCK_STATS` → агрегация из таблиц
- `MOCK_PAYOUTS` → запрос к `payouts`

## Переменные окружения

Добавь в `.env`:
```
VITE_SUPABASE_URL=твой_url
VITE_SUPABASE_ANON_KEY=твой_ключ
```

## Проверка

После интеграции должно работать:
✅ Регистрация партнёра
✅ Вход в кабинет
✅ Отображение статистики
✅ Список рефералов
✅ Запрос на выплату
✅ Админ-вход и статистика

---

Начни с создания таблиц в Supabase, потом настрой авторизацию, затем подключи данные к страницам.

